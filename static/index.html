<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ad-Wise ‚Äî AI-Powered Performance Ad Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:        #fff5f8;
      --surface:   #ffffff;
      --border:    #f5d5e0;
      --border2:   #f0b8cc;
      --violet:    #ff2d6b;
      --violet-lt: #fff0f4;
      --violet-glow: rgba(255,45,107,0.18);
      --cyan:      #ff6b35;
      --cyan-lt:   #fff4ef;
      --pink:      #c8003a;
      --pink-lt:   #fff0f4;
      --lime:      #ff4d7d;
      --lime-lt:   #fff0f4;
      --text:      #1f0812;
      --text2:     #6b2040;
      --muted:     #c47a95;
      --user-bg:#ffe0ea; --bot-bg:#ffffff;
      --radius:18px; --font:'Plus Jakarta Sans',sans-serif; --mono:'Fira Code',monospace;
    }
    body { background:var(--bg); color:var(--text); font-family:var(--font); height:100dvh; display:flex; flex-direction:column; overflow:hidden;
      background-image: radial-gradient(ellipse 60% 40% at 10% 0%, rgba(255,45,107,0.09) 0%, transparent 60%), radial-gradient(ellipse 50% 35% at 90% 100%, rgba(255,107,53,0.07) 0%, transparent 60%); }
    header { display:flex; align-items:center; gap:14px; padding:13px 24px; background:rgba(255,255,255,0.88); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); flex-shrink:0; box-shadow:0 2px 16px rgba(255,45,107,0.08); z-index:10; }
    .logo-wrap { width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,#ffb3cc 0%,#ffcce0 100%); display:grid; place-items:center; flex-shrink:0; box-shadow:0 4px 16px var(--violet-glow); font-size:1.2rem; }
    .brand-name { font-size:1.05rem; font-weight:800; color:var(--text); letter-spacing:-0.02em; }
    .brand-tag  { font-size:0.63rem; font-weight:500; color:var(--muted); letter-spacing:0.06em; text-transform:uppercase; margin-top:1px; }
    .header-right { margin-left:auto; display:flex; gap:8px; }
    .nav-btn { background:var(--surface); border:1px solid var(--border); color:var(--text2); padding:6px 14px; border-radius:10px; font-family:var(--font); font-size:0.75rem; font-weight:600; cursor:pointer; transition:all 0.18s; }
    .nav-btn:hover { border-color:var(--violet); color:var(--violet); background:var(--violet-lt); }
    .nav-btn:disabled { opacity:0.35; cursor:not-allowed; }

    #chat { flex:1; overflow-y:auto; padding:24px 0 10px; display:flex; flex-direction:column; gap:0; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
    #chat::-webkit-scrollbar { width:4px; } #chat::-webkit-scrollbar-thumb { background:var(--border2); border-radius:4px; }

    .msg-row { display:flex; padding:6px 24px; animation:fadeIn .25s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .msg-row.user { justify-content:flex-end; }
    .msg-row.bot  { justify-content:flex-start; }
    .bubble { max-width:72%; padding:12px 16px; border-radius:var(--radius); line-height:1.6; font-size:.92rem; }
    .msg-row.user .bubble { background:linear-gradient(135deg,var(--violet) 0%,#ff6b9d 100%); color:#fff; border-bottom-right-radius:4px; box-shadow:0 4px 16px var(--violet-glow); font-weight:500; }
    .msg-row.bot  .bubble { background:var(--bot-bg); border:1px solid var(--border); border-bottom-left-radius:4px; box-shadow:0 2px 12px rgba(255,45,107,0.06); }
    .bubble strong { color:var(--violet); font-weight:700; }
    .bubble em     { color:var(--muted); font-style:normal; font-size:.85em; }

    .options-row { padding:8px 24px 4px; display:flex; flex-wrap:wrap; gap:8px; animation:fadeIn .3s ease; }
    .opt-btn { background:var(--surface); border:1.5px solid var(--border); color:var(--text); padding:9px 16px; border-radius:12px; font-family:var(--font); font-size:.85rem; font-weight:600; cursor:pointer; transition:all .18s; text-align:left; box-shadow:0 2px 8px rgba(255,45,107,0.06); }
    .opt-btn:hover { border-color:var(--violet); color:var(--violet); background:var(--violet-lt); transform:translateY(-1px); box-shadow:0 6px 20px var(--violet-glow); }
    .opt-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; }
    .opt-desc { display:block; font-size:.73rem; color:var(--muted); margin-top:2px; font-weight:400; }

    .result-box { margin:8px 24px; background:var(--surface); border:1.5px solid var(--border2); border-radius:var(--radius); overflow:visible; animation:fadeIn .3s ease; box-shadow:0 8px 40px rgba(255,45,107,0.10); }
    .result-box pre { font-family:var(--mono); font-size:.82rem; line-height:1.7; padding:16px 18px; white-space:pre-wrap; word-break:break-word; color:var(--text); background:#fff8fa; }
    .result-header { background:linear-gradient(90deg,var(--lime-lt) 0%,#fff8fa 100%); padding:8px 18px; font-size:.78rem; font-weight:700; color:var(--lime); letter-spacing:.06em; text-transform:uppercase; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
    .result-dot { width:7px; height:7px; background:var(--lime); border-radius:50%; animation:blink 1.8s infinite; box-shadow:0 0 6px var(--lime); }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .copy-btn { display:block; width:100%; background:none; border:none; border-top:1px solid var(--border); color:var(--muted); padding:8px; font-family:var(--font); font-size:.78rem; font-weight:600; cursor:pointer; transition:all .2s; }
    .copy-btn:hover { background:var(--violet-lt); color:var(--violet); }

    .steps-toggle { margin:10px 16px 0 !important; padding:10px 12px; font-size:.82rem; font-weight:700; color:var(--violet); border:1px solid var(--border); border-radius:10px; background:var(--violet-lt); cursor:pointer; text-align:left; width:fit-content; font-family:var(--font); transition:all .2s; }
    .steps-toggle:hover { border-color:var(--violet); background:rgba(255,45,107,0.1); }
    .steps-panel { margin:4px 24px 8px; background:var(--surface); border:1px solid var(--border); border-radius:10px; overflow:hidden; }
    .steps-panel pre { font-family:var(--mono); font-size:.72rem; padding:12px 14px; white-space:pre-wrap; word-break:break-word; color:var(--muted); max-height:360px; overflow-y:auto; }
    details summary::-webkit-details-marker { display:none; } details summary { list-style:none; }

    .typing { display:flex; align-items:center; gap:5px; padding:10px 16px; }
    .typing span { width:7px; height:7px; border-radius:50%; animation:bounce .9s infinite; }
    .typing span:nth-child(1) { background:var(--violet); }
    .typing span:nth-child(2) { background:var(--cyan); animation-delay:.15s; }
    .typing span:nth-child(3) { background:var(--pink); animation-delay:.3s; }
    @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

    #input-bar { padding:14px 24px; border-top:1px solid var(--border); background:rgba(255,255,255,0.92); backdrop-filter:blur(12px); display:flex; gap:10px; flex-shrink:0; box-shadow:0 -4px 24px rgba(255,45,107,0.07); z-index:10; }
    #user-input { flex:1; background:var(--bg); border:1.5px solid var(--border); border-radius:12px; color:var(--text); font-family:var(--font); font-size:.9rem; padding:10px 14px; resize:none; height:44px; max-height:120px; overflow-y:auto; outline:none; transition:all .2s; }
    #user-input:focus { border-color:var(--violet); box-shadow:0 0 0 3px rgba(255,45,107,0.12); }
    #user-input::placeholder { color:var(--muted); }
    #run-btn { background:linear-gradient(135deg,var(--violet) 0%,var(--pink) 100%); color:#fff; border:none; border-radius:12px; height:44px; padding:0 18px; font-size:.9rem; font-weight:800; cursor:pointer; transition:all .18s; flex-shrink:0; display:grid; place-items:center; min-width:120px; box-shadow:0 4px 20px rgba(255,45,107,0.35); font-family:var(--font); }
    #run-btn:hover { transform:translateY(-1px); box-shadow:0 8px 28px rgba(255,45,107,0.45); filter:brightness(1.05); }
    #run-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; box-shadow:none; }
    #send-btn { background:var(--surface); color:var(--text2); border:1.5px solid var(--border); border-radius:12px; width:44px; height:44px; font-size:1.1rem; cursor:pointer; transition:all .18s; display:grid; place-items:center; flex-shrink:0; }
    #send-btn:hover { border-color:var(--cyan); color:var(--cyan); background:var(--cyan-lt); }
    #send-btn:disabled { opacity:.4; cursor:not-allowed; }
  </style>
</head>
<body>
<header>
  <div class="logo-wrap">‚ú®</div>
  <div>
    <div class="brand-name">Ad-Wise</div>
    <div class="brand-tag">AI-Powered Performance Ad Generator</div>
  </div>
  <div class="header-right">
    <button id="back-btn" class="nav-btn" onclick="goBack()">‚Üê Back</button>
    <button class="nav-btn" onclick="restart()">‚Ü∫ Restart</button>
  </div>
</header>

<div id="chat"></div>

<div id="input-bar">
  <textarea id="user-input" placeholder="Describe your product or write a prompt‚Ä¶" rows="1"></textarea>
  <button id="run-btn" onclick="runAgentExecute()">‚ú¶ Run Agent</button>
  <button id="send-btn" onclick="sendMessageWizard()" title="Wizard Chat">‚û§</button>
</div>

<script>
let convState = null;
let busy = false;
let lastWizardAgentPrompt = "";

window.onload = () => callChat("hi", null);

function restart() {
  document.getElementById("chat").innerHTML = "";
  convState = null;
  lastWizardAgentPrompt = "";
  callChat("hi", null);
}

function canGoBack() {
  return convState && convState.step && convState.step !== "GREETING" && convState.step !== "MENU";
}
function updateNavButtons() {
  const backBtn = document.getElementById("back-btn");
  if (!backBtn) return;
  backBtn.disabled = busy || !canGoBack();
}
function goBack() {
  if (busy || !canGoBack()) return;
  callChat("__back", convState);
}

function sendMessageWizard() {
  const inp = document.getElementById("user-input");
  const text = inp.value.trim();
  if (!text || busy) return;
  inp.value = ""; inp.style.height = "44px";
  appendUserBubble(text);
  callChat(text, convState);
}

function runAgentExecute() {
  const inp = document.getElementById("user-input");
  const typed = inp.value.trim();
  const promptToRun = typed || lastWizardAgentPrompt;
  if (!promptToRun || busy) {
    appendBotBubble("‚ö†Ô∏è Please type a prompt, or complete the Wizard once so I can use your selections.");
    return;
  }
  inp.value = ""; inp.style.height = "44px";
  if (!typed && lastWizardAgentPrompt) {
    appendUserBubble("Run Agent (using Wizard selections)");
  } else {
    appendUserBubble(typed);
  }
  callExecute(promptToRun);
}

document.getElementById("user-input").addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); runAgentExecute(); }
});
document.addEventListener("keydown", e => {
  if (e.key === "Escape") { e.preventDefault(); goBack(); }
});
function chooseOption(id, label) {
  if (busy) return;
  document.querySelectorAll(".opt-btn").forEach(b => b.disabled = true);
  appendUserBubble(label);
  callChat(id, convState);
}

async function callExecute(prompt) {
  busy = true; updateNavButtons();
  document.getElementById("send-btn").disabled = true;
  document.getElementById("run-btn").disabled = true;
  const typingEl = appendTyping();
  try {
    const res = await fetch("/api/execute", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });
    if (!res.ok) { const t = await res.text(); throw new Error("HTTP " + res.status + " ‚Äî " + t.slice(0,300)); }
    const data = await res.json();
    typingEl.remove();
    if (data.status === "error") { appendBotBubble("‚ùå Error: " + (data.error || "Unknown error")); return; }
    const resultText = (data.response || "").trim();
    appendResult(resultText || "(empty response)", data.steps);
    setTimeout(() => appendBotBubble("‚úÖ Done! You can run another prompt."), 120);
  } catch (err) { typingEl.remove(); appendBotBubble("‚ùå Error: " + err.message); }
  finally { busy = false; updateNavButtons(); document.getElementById("send-btn").disabled = false; document.getElementById("run-btn").disabled = false; scrollBottom(); }
}

async function callChat(prompt, state) {
  busy = true; updateNavButtons();
  document.getElementById("send-btn").disabled = true;
  document.getElementById("run-btn").disabled = true;
  const typingEl = appendTyping();
  try {
    const res = await fetch("/api/chat", {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, state })
    });
    if (!res.ok) { const t = await res.text(); throw new Error("HTTP " + res.status + " ‚Äî " + t.slice(0,300)); }
    const data = await res.json();
    typingEl.remove();
    convState = data.next_state || null;
    if (typeof data.agent_prompt === "string" && data.agent_prompt.trim()) {
      lastWizardAgentPrompt = data.agent_prompt.trim();
      const inp = document.getElementById("user-input");
      if (inp && !inp.value.trim()) inp.value = lastWizardAgentPrompt;
    }
    renderBotTurn(data);
  } catch (err) { typingEl.remove(); appendBotBubble("‚ùå Error: " + err.message); }
  finally { busy = false; updateNavButtons(); document.getElementById("send-btn").disabled = false; document.getElementById("run-btn").disabled = false; scrollBottom(); }
}

function renderBotTurn(data) {
  const uiType = (data.ui_type || "text").trim();
  if (data.status === "error") { appendBotBubble("‚ùå Error: " + data.error); return; }
  if (uiType === "result") {
    const resultText = (data.response || data.message || "").trim();
    appendResult(resultText || "(empty response)", data.steps);
    return;
  }
  const msg = data.message || data.response || "";
  if (msg) appendBotBubble(msg);
  if ((uiType === "menu" || uiType === "categories") && data.options) appendOptions(data.options, uiType === "menu");
}

const chat = () => document.getElementById("chat");

function appendUserBubble(text) {
  const row = document.createElement("div"); row.className = "msg-row user";
  row.innerHTML = `<div class="bubble">${esc(text)}</div>`;
  chat().appendChild(row); scrollBottom();
}
function appendBotBubble(md) {
  const row = document.createElement("div"); row.className = "msg-row bot";
  row.innerHTML = `<div class="bubble">${renderMd(md)}</div>`;
  chat().appendChild(row); scrollBottom();
}
function appendTyping() {
  const row = document.createElement("div"); row.className = "msg-row bot";
  row.innerHTML = `<div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
  chat().appendChild(row); scrollBottom(); return row;
}
function appendOptions(options, hasDesc) {
  const wrap = document.createElement("div"); wrap.className = "options-row";
  const opts = Array.isArray(options) ? [...options] : [];
  if (canGoBack() && !opts.some(o => o && o.id === "__back"))
    opts.push({ id: "__back", label: "‚¨Ö Back", desc: "Return to previous step" });
  opts.forEach(opt => {
    const btn = document.createElement("button"); btn.className = "opt-btn";
    btn.onclick = () => chooseOption(opt.id, opt.label);
    btn.innerHTML = esc(opt.label) + (hasDesc && opt.desc ? `<span class="opt-desc">${esc(opt.desc)}</span>` : "");
    wrap.appendChild(btn);
  });
  chat().appendChild(wrap); scrollBottom();
}
function appendResult(text, steps) {
  const box = document.createElement("div"); box.className = "result-box";
  const header = document.createElement("div"); header.className = "result-header";
  header.innerHTML = `<div class="result-dot"></div> Generated Output`;
  const pre = document.createElement("pre"); pre.textContent = text;
  const copyBtn = document.createElement("button"); copyBtn.className = "copy-btn";
  copyBtn.textContent = "üìã Copy to clipboard";
  copyBtn.onclick = () => { navigator.clipboard.writeText(text).then(() => { copyBtn.textContent = "‚úÖ Copied!"; setTimeout(() => copyBtn.textContent = "üìã Copy to clipboard", 2000); }); };
  box.appendChild(header); box.appendChild(pre); box.appendChild(copyBtn);

  const stepsArr = Array.isArray(steps) ? steps : [];
  const toggle = document.createElement("button"); toggle.className = "steps-toggle";
  toggle.style.margin = "10px 16px 0";
  toggle.textContent = `‚ñ∂ Show execution steps (${stepsArr.length})`;
  const panel = document.createElement("div"); panel.className = "steps-panel"; panel.style.display = "none"; panel.style.margin = "8px 16px 14px";
  if (stepsArr.length === 0) {
    panel.innerHTML = `<pre>${esc("No steps returned from the API.")}</pre>`;
  } else {
    const container = document.createElement("div"); container.style.padding = "10px 12px";
    stepsArr.forEach((s, i) => {
      const d = document.createElement("details");
      d.style.cssText = "border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-bottom:8px;background:rgba(255,45,107,0.02);";
      const sum = document.createElement("summary");
      sum.style.cssText = "cursor:pointer;color:var(--text2);font-family:var(--mono);";
      sum.textContent = String(i+1).padStart(2,"0") + " ‚Äî " + (s.module || "UnknownModule");
      d.appendChild(sum);
      const pre2 = document.createElement("pre");
      pre2.style.cssText = "margin-top:8px;font-family:var(--mono);font-size:.72rem;white-space:pre-wrap;word-break:break-word;color:var(--muted);";
      pre2.textContent = "module: "+(s.module||"")+"\n\nprompt:\n"+JSON.stringify(s.prompt||{},null,2)+"\n\nresponse:\n"+JSON.stringify(s.response||{},null,2);
      d.appendChild(pre2); container.appendChild(d);
    });
    panel.appendChild(container);
  }
  toggle.onclick = () => {
    const isOpen = panel.style.display !== "none";
    panel.style.display = isOpen ? "none" : "block";
    toggle.textContent = (isOpen ? "‚ñ∂" : "‚ñº") + ` Show execution steps (${stepsArr.length})`;
    if (!isOpen) panel.scrollIntoView({ behavior:"smooth", block:"nearest" });
  };
  box.appendChild(toggle); box.appendChild(panel);
  chat().appendChild(box); scrollBottom();
}

function esc(s) { return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function renderMd(s) {
  let out = esc(s);
  out = out.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");
  out = out.replace(/(^|\s)_(.+?)_(?=\s|$)/g,"$1<em>$2</em>");
  out = out.replace(/\n/g,"<br>");
  return out;
}
function scrollBottom() { const c=chat(); requestAnimationFrame(()=>c.scrollTop=c.scrollHeight); }
document.getElementById("user-input").addEventListener("input", function(){ this.style.height="44px"; this.style.height=Math.min(this.scrollHeight,120)+"px"; });
updateNavButtons();
</script>
</body>
</html>